<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pula Puti 逐局互動模擬器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* 球動畫效果 */
        .ball-animation {
            animation: drop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            transform: scale(0.5);
            opacity: 0;
        }
        @keyframes drop-in {
            0% {
                transform: scale(0.5) translateY(-50px);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        /* 特殊JP格的閃爍效果 */
        .jp-cell {
            position: relative;
            overflow: hidden;
        }
        .jp-cell::before {
            content: 'JP';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px black;
        }
        .jp-cell::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                rgba(255, 215, 0, 0.5),
                transparent 30%
            );
            animation: rotate 4s linear infinite;
        }
        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Pula Puti 互動模擬器</h1>
            <p class="text-lg text-gray-600 mt-2">Round-by-Round Interactive Simulator</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左側: 遊戲盤面與控制 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center">遊戲盤面</h2>
                <div id="game-board" class="grid grid-cols-6 gap-2 aspect-square max-w-lg mx-auto mb-6">
                    <!-- 遊戲格將由 JavaScript 動態生成 -->
                </div>
                <div class="text-center">
                    <button id="next-round-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 text-xl">
                        進行下一局
                    </button>
                </div>
            </div>

            <!-- 右側: 統計與歷史紀錄 -->
            <div class="space-y-8">
                <!-- 即時統計 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">即時統計</h2>
                    <div id="stats-display" class="space-y-3 text-lg">
                        <p class="font-semibold">總局數: <span id="total-rounds" class="text-indigo-600">0</span></p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div>2紅1白: <span id="stats-2r1w" class="font-mono">0.00% (0)</span></div>
                            <div>1紅2白: <span id="stats-1r2w" class="font-mono">0.00% (0)</span></div>
                            <div>三紅: <span id="stats-3r" class="font-mono">0.00% (0)</span></div>
                            <div>三白: <span id="stats-3w" class="font-mono">0.00% (0)</span></div>
                        </div>
                    </div>
                </div>

                <!-- 歷史紀錄 -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">歷史紀錄</h2>
                    <ul id="history-list" class="space-y-2 h-96 overflow-y-auto pr-2">
                        <li class="text-gray-500 text-center pt-8">尚無歷史紀錄</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 遊戲設定 (來自 config.json) ---
        // 由於瀏覽器安全限制，我們不能直接讀取本地檔案。
        // 因此，將 landing_cell_weights 的內容直接嵌入到程式碼中。
        const CONFIG = {
            landing_cell_weights: {
                "1": 10, "2": 10, "3": 10, "4": 10, "5": 10, "6": 10,
                "7": 10, "8": 1, "9": 10, "10": 10, "11": 1, "12": 10,
                "13": 10, "14": 10, "15": 10, "16": 10, "17": 10, "18": 10,
                "19": 10, "20": 10, "21": 10, "22": 10, "23": 10, "24": 10,
                "25": 10, "26": 1, "27": 10, "28": 10, "29": 1, "30": 10,
                "31": 10, "32": 10, "33": 10, "34": 10, "35": 10, "36": 10
            }
        };

        // --- DOM 元素 ---
        const gameBoard = document.getElementById('game-board');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const totalRoundsEl = document.getElementById('total-rounds');
        const stats2r1wEl = document.getElementById('stats-2r1w');
        const stats1r2wEl = document.getElementById('stats-1r2w');
        const stats3rEl = document.getElementById('stats-3r');
        const stats3wEl = document.getElementById('stats-3w');
        const historyList = document.getElementById('history-list');

        // --- 遊戲狀態 ---
        let boardData = [];
        let history = [];
        let statsCounter = {
            "2_red_1_white": 0,
            "1_red_2_white": 0,
            "triple_red": 0,
            "triple_white": 0
        };

        // --- 核心邏輯函式 (從 Python 移植) ---

        /**
         * 初始化36格遊戲版面數據
         */
        function initializeBoard() {
            const cells = [];
            const specialIds = new Set([8, 11, 26, 29]); // (2-1)*6+2=8, (2-1)*6+5=11, etc.
            for (let i = 1; i <= 36; i++) {
                const row = Math.floor((i - 1) / 6);
                const col = (i - 1) % 6;
                const color = (row + col) % 2 === 0 ? '紅' : '白';
                cells.push({ id: i, color: color, isSpecial: specialIds.has(i) });
            }
            return cells;
        }

        /**
         * 實現帶權重且不重複的抽樣
         * @param {Object} populationWithWeights - 帶權重的物件 { item: weight }
         * @param {number} k - 要抽樣的數量
         * @returns {Array} - 抽樣結果陣列
         */
        function weightedSampleWithoutReplacement(populationWithWeights, k = 3) {
            let population = Object.keys(populationWithWeights);
            let weights = Object.values(populationWithWeights);
            
            if (population.length < k) {
                throw new Error("Cannot sample more items than exist in the population.");
            }

            const result = [];
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);

            for (let i = 0; i < k; i++) {
                let cumulativeWeight = 0;
                const randomNum = Math.random() * weights.reduce((a, b) => a + b, 0);
                let chosenIndex = -1;

                for (let j = 0; j < population.length; j++) {
                    cumulativeWeight += weights[j];
                    if (randomNum < cumulativeWeight) {
                        chosenIndex = j;
                        break;
                    }
                }
                
                const chosenItem = population[chosenIndex];
                result.push(chosenItem);

                // 移除已選中的項目及其權重
                population.splice(chosenIndex, 1);
                weights.splice(chosenIndex, 1);
            }
            return result;
        }

        /**
         * 執行一局遊戲的核心邏輯
         * @param {Object} landingWeights - 落球權重
         * @param {Object} boardDict - 盤面資料字典
         * @returns {Object} - 該局結果的物件
         */
        function runOneRound(landingWeights, boardDict) {
            const chosenCellIds = weightedSampleWithoutReplacement(landingWeights, 3);
            const balls = chosenCellIds.map(id => boardDict[id]);

            const redCount = balls.filter(ball => ball.color === '紅').length;
            const whiteCount = 3 - redCount;

            let winText, statsKey;
            if (redCount === 3) {
                winText = "三紅勝";
                statsKey = "triple_red";
            } else if (redCount === 0) {
                winText = "三白勝";
                statsKey = "triple_white";
            } else if (redCount > 1) {
                winText = "紅勝";
                statsKey = "2_red_1_white";
            } else {
                winText = "白勝";
                statsKey = "1_red_2_white";
            }

            return {
                chosenIds: chosenCellIds.map(Number).sort((a, b) => a - b),
                redCount,
                whiteCount,
                winText,
                statsKey
            };
        }

        // --- UI 更新函式 ---

        /**
         * 渲染整個遊戲盤面
         */
        function renderBoard() {
            gameBoard.innerHTML = '';
            boardData.forEach(cell => {
                const cellEl = document.createElement('div');
                cellEl.id = `cell-${cell.id}`;
                cellEl.className = `flex items-center justify-center aspect-square rounded-lg text-white font-bold text-xl shadow-inner transition-transform duration-300`;
                
                if (cell.color === '紅') {
                    cellEl.classList.add('bg-red-500');
                } else {
                    cellEl.classList.add('bg-gray-600');
                }
                
                if (cell.isSpecial) {
                    cellEl.classList.add('jp-cell');
                }
                
                cellEl.textContent = cell.id;
                gameBoard.appendChild(cellEl);
            });
        }

        /**
         * 更新儀表板的所有資訊
         */
        function updateDashboard() {
            const totalRounds = history.length;
            
            // 更新統計
            totalRoundsEl.textContent = totalRounds;
            if (totalRounds > 0) {
                const p2r1w = statsCounter["2_red_1_white"] / totalRounds;
                const p1r2w = statsCounter["1_red_2_white"] / totalRounds;
                const p3r = statsCounter["triple_red"] / totalRounds;
                const p3w = statsCounter["triple_white"] / totalRounds;

                stats2r1wEl.textContent = `${(p2r1w * 100).toFixed(2)}% (${statsCounter["2_red_1_white"]})`;
                stats1r2wEl.textContent = `${(p1r2w * 100).toFixed(2)}% (${statsCounter["1_red_2_white"]})`;
                stats3rEl.textContent = `${(p3r * 100).toFixed(2)}% (${statsCounter["triple_red"]})`;
                stats3wEl.textContent = `${(p3w * 100).toFixed(2)}% (${statsCounter["triple_white"]})`;
            }

            // 更新歷史紀錄
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<li class="text-gray-500 text-center pt-8">尚無歷史紀錄</li>';
            } else {
                history.forEach((result, index) => {
                    const li = document.createElement('li');
                    const roundNum = history.length - index;
                    const idStr = result.chosenIds.join(', ');
                    const colorStr = `${result.redCount}紅 ${result.whiteCount}白`;
                    
                    let winColorClass = '';
                    if (result.winText.includes('紅')) winColorClass = 'text-red-600';
                    if (result.winText.includes('白')) winColorClass = 'text-gray-700';

                    li.className = 'p-2 rounded-md transition-colors duration-200';
                    if (index === 0) li.classList.add('bg-indigo-100');

                    li.innerHTML = `
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-bold text-gray-500">第 ${roundNum} 局</span>
                            <span class="font-mono text-xs">${idStr}</span>
                            <span class="font-semibold ${winColorClass}">${result.winText}</span>
                        </div>
                    `;
                    historyList.prepend(li); // prepend 將新項目加到最前面
                });
            }
        }
        
        /**
         * 處理下一局的點擊事件
         */
        function handleNextRound() {
            // 1. 清除上一局的動畫效果
            document.querySelectorAll('.ball-animation').forEach(el => el.classList.remove('ball-animation'));
            document.querySelectorAll('.scale-125').forEach(el => el.classList.remove('scale-125', 'shadow-2xl', 'z-10'));


            // 2. 執行一局遊戲
            const boardDict = Object.fromEntries(boardData.map(cell => [cell.id, cell]));
            const result = runOneRound(CONFIG.landing_cell_weights, boardDict);

            // 3. 更新狀態
            history.unshift(result); // 將最新結果加到陣列最前面
            if (history.length > 100) history.pop(); // 維持最多100筆紀錄
            statsCounter[result.statsKey]++;

            // 4. 更新UI
            updateDashboard();

            // 5. 顯示本局結果的動畫
            result.chosenIds.forEach((id, index) => {
                const cellEl = document.getElementById(`cell-${id}`);
                if (cellEl) {
                    setTimeout(() => {
                        cellEl.classList.add('ball-animation', 'scale-125', 'shadow-2xl', 'z-10');
                    }, index * 100); // 讓球依序落下
                }
            });
        }

        // --- 初始化 ---
        function init() {
            boardData = initializeBoard();
            renderBoard();
            updateDashboard();
            nextRoundBtn.addEventListener('click', handleNextRound);
        }

        // 啟動應用程式
        init();

    </script>
</body>
</html>
